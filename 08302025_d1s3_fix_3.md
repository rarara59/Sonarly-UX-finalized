# Fix Session 3: Backpressure Implementation - Claude Code Prompt

**Return to Claude Code with this exact prompt:**

```
I need to implement backpressure management to prevent system overload during viral meme coin events.

PROBLEM IDENTIFIED: System accepts unlimited concurrent requests and becomes overwhelmed, leading to cascading failures.

PREREQUISITE: Fix Session 1 (Connection Pool) + Fix Session 2 (Resource Cleanup) COMPLETED

CURRENT SYSTEM STATUS:
- Connection pool properly manages resources
- Memory leaks eliminated, stable memory growth
- System still needs protection against request overload
- Target: Graceful degradation under extreme load instead of system failure

## SINGLE FOCUS: Implement Request Backpressure Management

TASK: Add load shedding and request limiting to prevent system overload during high-demand periods like viral meme coin events.

### Explicit Files to Modify:
**Primary**: `src/detection/transport/rpc-connection-pool.js` - Add BackpressureManager integration
**Secondary**: `scripts/test-backpressure.js` - Create overload protection validation

### Incremental Implementation Process:

**Step 1**: Add BackpressureManager class for load limiting
**Step 2**: Integrate backpressure control in RpcConnectionPool.call() method
**Step 3**: Test system behavior under moderate overload (30 concurrent requests)
**Step 4**: Test system behavior under extreme overload (50+ concurrent requests)
**Step 5**: Validate graceful degradation and recovery patterns

### Clear Success Criteria:

**Load Management Requirements**:
- System maintains 95%+ success rate under 20 concurrent requests (normal load)
- System gracefully rejects excess requests when overloaded (fast-fail)
- Queue size limited to prevent memory exhaustion during overload
- System recovers automatically when load decreases
- Clear error messages for rejected requests (not system crashes)

**Performance Requirements**:
- Request rejection time under 10ms (fast-fail for overload)
- Queue management overhead under 5ms per request
- System throughput maintained at sustainable level during overload
- No performance degradation for accepted requests during load shedding
- Automatic load recovery within 30 seconds after overload ends

**Protection Requirements**:
- Maximum concurrent requests: 20 (matches connection pool limit)
- Maximum queue size: 50 pending requests
- Queue timeout: 5000ms maximum wait time
- Rejection message: Clear indication of system overload
- Monitoring: Track rejection rate and queue depth

### Implementation Requirements:

**Backpressure Manager Design**:
- Concurrent request counter with atomic operations
- Bounded queue for pending requests when at capacity
- Fast-fail rejection when queue is full
- Automatic slot notification when requests complete
- Load metrics collection for monitoring

**Integration Strategy**:
- Wrap RpcConnectionPool.call() with backpressure checking
- Implement before connection pool acquisition
- Maintain existing error handling and logging
- Add backpressure metrics to health monitoring
- Preserve circuit breaker functionality

### Testing Requirements:
- Test normal load (10-20 requests) maintains full performance
- Test moderate overload (30 requests) with partial rejection
- Test extreme overload (50+ requests) with majority rejection
- Verify system recovers when load returns to normal
- Test queue timeout behavior during sustained overload

### Expected Changes:

**Modified File**: `src/detection/transport/rpc-connection-pool.js`
- Add BackpressureManager class with load limiting logic
- Modify call() method to check backpressure before processing
- Add queue management for requests waiting for capacity
- Implement fast-fail rejection when system overloaded
- Add backpressure metrics to existing health reporting

**New File**: `scripts/test-backpressure.js`
- Test various load levels (10, 20, 30, 50 concurrent requests)
- Measure acceptance/rejection rates at each load level
- Verify system recovery after overload periods
- Test queue timeout behavior
- Report backpressure effectiveness metrics

### Performance Requirements to Measure:

**Load Shedding Metrics**:
- Acceptance rate at 20 concurrent: 100% (normal capacity)
- Acceptance rate at 30 concurrent: 60-70% (partial shedding)
- Acceptance rate at 50 concurrent: 30-40% (heavy shedding)
- Request rejection time: <10ms for overload scenarios
- System recovery time: <30 seconds after load decreases

**System Protection Metrics**:
- Memory usage during overload: Stable (no queue growth beyond limits)
- Success rate for accepted requests: 95%+ even during load shedding
- Queue depth monitoring: Never exceeds 50 pending requests
- Response time for accepted requests: Unaffected by load shedding
- Error message clarity: Clear overload indication

### If Backpressure Implementation Fails:
1. Test BackpressureManager in isolation before integration
2. Verify queue management works correctly under various load patterns
3. Ensure backpressure doesn't interfere with normal operation
4. Do not proceed to circuit breaker tuning until load management works

CRITICAL REQUIREMENTS:
- System must maintain 95%+ success rate for accepted requests during overload
- Request rejection must be fast (<10ms) to prevent cascade failures
- Queue size must be bounded to prevent memory exhaustion
- System must recover automatically when overload conditions end
- Load shedding must not interfere with normal operation under capacity

SUCCESS CRITERIA SUMMARY:
- Graceful degradation under overload instead of system failure
- Fast-fail rejection of excess requests with clear error messages
- System maintains performance for accepted requests during load shedding
- Automatic recovery when load returns to normal levels
- Ready for Fix Session 4 (Circuit Breaker Tuning)
```

## Your Post-Fix Process

After Claude Code completes backpressure implementation:

**Step 1: Test Load Shedding**
```bash
# Test backpressure under various loads
node scripts/test-backpressure.js

# Verify acceptance rates at different load levels
grep -i "acceptance.*rate\|rejection.*rate" backpressure-test-results.txt

# Check that system maintains performance for accepted requests
grep -i "success.*rate.*accepted" backpressure-test-results.txt
```

**Step 2: Validate Overload Protection**
```bash
# Test extreme overload scenario
node -e "
// Simulate 100 concurrent requests to test overload protection
// System should reject excess quickly without crashing
"

# Monitor memory usage during overload (should remain stable)
ps aux | grep node | awk '{print $6}' # Should not grow excessively
```

**Step 3: Document Backpressure Results**
```bash
# Record backpressure effectiveness
echo "Fix Session 3 Backpressure: $(date)" >> development.log
echo "Load shedding working: $(grep -q 'graceful.*rejection' backpressure-test-results.txt && echo 'YES' || echo 'NO')" >> development.log

# Commit backpressure implementation
git add src/detection/transport/rpc-connection-pool.js scripts/test-backpressure.js
git commit -m "Fix Session 3: Backpressure implementation - Load shedding prevents system overload"
```

This focused approach addresses only the request overload protection without attempting to solve circuit breaker tuning simultaneously.