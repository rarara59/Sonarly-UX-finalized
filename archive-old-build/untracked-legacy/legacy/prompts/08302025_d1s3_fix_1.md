# Fix Session 1: Connection Pool Redesign - Claude Code Prompt

**Return to Claude Code with this exact prompt:**

```
I need to fix connection pool resource management issues that cause 23% success rate under sustained load.

PROBLEM IDENTIFIED: RPC connection pool runs out of available connections under 20 concurrent requests, causing "No available endpoints" errors.

CURRENT SYSTEM STATUS:
- Foundation and integration layers work correctly
- System fails under sustained load (23.44% success rate)
- Root cause: Connection pool resource exhaustion
- Target fix: Bounded connection pool with proper lifecycle management

## SINGLE FOCUS: Fix Connection Pool Resource Management

TASK: Redesign the RPC connection pool to properly manage connection lifecycle and prevent resource exhaustion under load.

### Explicit File to Modify:
**ONLY**: `src/detection/transport/rpc-connection-pool.js` - Add bounded connection pool implementation

### Incremental Implementation Process:

**Step 1**: Add BoundedConnectionPool class to existing file
**Step 2**: Integrate bounded pool with existing RpcConnectionPool class  
**Step 3**: Test basic connection acquire/release functionality
**Step 4**: Test connection pool under moderate load (10 concurrent requests)
**Step 5**: Test connection pool under high load (20+ concurrent requests)

### Clear Success Criteria:

**Basic Functionality Requirements**:
- Connection pool properly limits maximum concurrent connections
- Connections are acquired from pool before RPC calls
- Connections are released back to pool after RPC calls (success or failure)
- Pool handles connection timeouts gracefully
- Pool rejects requests when queue is full (fast-fail behavior)

**Performance Requirements**:
- Success rate under 20 concurrent requests: 95%+ (up from 23.44%)
- Connection acquisition timeout: 5 seconds maximum
- Pool queue size limit: 100 pending requests maximum  
- Connection reuse: Connections returned to pool, not recreated
- Memory stability: No connection object leaks

**Error Handling Requirements**:
- Pool exhaustion triggers clear error message, not "No available endpoints"
- Failed connections properly cleaned up and not returned to pool
- Timeout during connection acquisition handled gracefully
- Pool state remains consistent during errors

### Implementation Requirements:

**Connection Pool Design**:
- Maximum concurrent connections: 10 per endpoint
- Queue size limit: 100 pending requests  
- Connection acquisition timeout: 5000ms
- Fast-fail when queue full (don't wait indefinitely)
- Automatic connection cleanup on errors

**Integration with Existing Code**:
- Modify existing RpcConnectionPool.call() method to use bounded pool
- Maintain all existing endpoint rotation and failover logic
- Preserve existing circuit breaker integration
- Keep existing health monitoring functionality

### Testing Requirements:
- All tests must use real Solana RPC endpoints
- Test connection pool behavior under various load patterns
- Verify connection cleanup happens on both success and failure paths
- Measure improvement in success rate under sustained load
- Validate memory usage remains stable during connection cycling

### Expected Changes:

**Modified File**: `src/detection/transport/rpc-connection-pool.js`
- Add BoundedConnectionPool class implementation
- Modify RpcConnectionPool.call() method to use bounded pool
- Add connection lifecycle management
- Implement queue management with size limits
- Add proper cleanup in error paths

**Validation Script**: `scripts/test-connection-pool-fix.js`
- Test connection pool under 5, 10, 15, 20 concurrent requests
- Measure success rate improvement at each load level
- Verify no "No available endpoints" errors under reasonable load
- Test connection cleanup and pool state consistency

### If Connection Pool Fix Fails:
1. Identify specific connection management issue (acquisition, release, cleanup)
2. Test connection pool behavior in isolation before integration
3. Verify bounded pool logic works correctly with small test cases
4. Do not proceed to other fixes until connection pool works reliably

CRITICAL REQUIREMENTS:
- Connection pool must handle 20 concurrent requests with 95%+ success rate
- No more "No available endpoints" errors under reasonable load
- Connections must be properly cleaned up to prevent resource leaks
- Pool state must remain consistent during high load and error conditions
- Existing RPC functionality must continue working unchanged

SUCCESS CRITERIA SUMMARY:
- Success rate under 20 concurrent requests improves to 95%+
- Connection pool manages resources properly without exhaustion
- No connection leaks or resource starvation under sustained load
- Clear error messages when pool limits are reached
- Ready for Fix Session 2 (Resource Cleanup)
```

## Your Post-Fix Process

After Claude Code completes connection pool redesign:

**Step 1: Test Connection Pool Fix**
```bash
# Test the improved connection pool
node scripts/test-connection-pool-fix.js

# Check for success rate improvement
grep -i "success.*rate.*95\|success.*rate.*[6-9][0-9]" connection-pool-test-results.txt

# Look for "No available endpoints" errors (should be eliminated)
grep -i "no.*available.*endpoints" connection-pool-test-results.txt
```

**Step 2: Validate Resource Management**
```bash
# Run moderate load test
node -e "
// Test 15 concurrent requests for 30 seconds
const pool = require('./src/detection/transport/rpc-connection-pool.js');
// [Simple load test code]
"

# Check memory usage during test
ps aux | grep node | awk '{print $6}' # Monitor memory usage
```

**Step 3: Document Fix Results**
```bash
# Record fix results
echo "Fix Session 1 Connection Pool: $(date)" >> development.log
echo "Success rate improvement: $(grep -o '[0-9]*\.[0-9]*%' connection-pool-test-results.txt | tail -1)" >> development.log

# Commit connection pool fix
git add src/detection/transport/rpc-connection-pool.js scripts/test-connection-pool-fix.js
git commit -m "Fix Session 1: Connection pool redesign - Bounded connection pool with proper resource management"
```

This focused approach addresses only the connection pool resource exhaustion issue without trying to fix multiple complex problems simultaneously.