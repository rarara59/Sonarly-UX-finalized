# Fix Session 4: Circuit Breaker Tuning - Per-Endpoint Protection

**Return to Claude Code with this exact prompt:**

```
I need to implement per-endpoint circuit breakers to prevent cascade failures and improve endpoint isolation.

PROBLEM IDENTIFIED: Single circuit breaker only prevents 50% of cascade failures, endpoint failures not properly isolated.

PREREQUISITE: Fix Sessions 1-3 COMPLETED (Connection Pool + Resource Cleanup + Backpressure)

CURRENT SYSTEM STATUS:
- Connection pool manages resources properly
- Memory leaks eliminated with stable growth
- Backpressure prevents system overload
- Current circuit breaker prevents only 50% of cascades (target: 90%+)
- Need per-endpoint isolation for Helius, Chainstack P2Pify, Public RPC

## SINGLE FOCUS: Implement Per-Endpoint Circuit Breaker Protection

TASK: Replace single system-wide circuit breaker with per-endpoint circuit breakers to isolate failures and improve cascade prevention.

### Explicit Files to Modify:
**Primary**: `src/detection/transport/rpc-connection-pool.js` - Replace single breaker with per-endpoint breakers
**Secondary**: `scripts/test-circuit-breakers.js` - Create endpoint isolation validation

### Incremental Implementation Process:

**Step 1**: Add PerEndpointCircuitBreaker class with individual endpoint tracking
**Step 2**: Replace existing circuit breaker logic with per-endpoint implementation
**Step 3**: Test circuit breaker behavior for individual endpoint failures
**Step 4**: Test cascade prevention during multiple endpoint failures
**Step 5**: Validate recovery behavior and state transitions per endpoint

### Clear Success Criteria:

**Endpoint Isolation Requirements**:
- Each endpoint (Helius, Chainstack, Public) has independent circuit breaker
- Failure of one endpoint doesn't trigger breaker on healthy endpoints
- Cascade prevention rate improves to 90%+ (up from 50%)
- Failed endpoint recovery happens independently of other endpoints
- Circuit breaker state visible per endpoint in health monitoring

**Circuit Breaker Behavior Requirements**:
- Breaker opens after 3 consecutive failures (reduced from 5 for faster protection)
- Half-open state requires 2 consecutive successes to close (improved recovery)
- Open breaker timeout: 30 seconds before attempting recovery
- State transitions: CLOSED → OPEN → HALF_OPEN → CLOSED per endpoint
- Fast-fail when endpoint breaker is OPEN (no cascading attempts)

**Failure Prevention Requirements**:
- Endpoint rotation continues with healthy endpoints when one fails
- No more "all endpoints failed" scenarios due to cascade failures
- Individual endpoint recovery without affecting other endpoints
- Clear error messages indicating which specific endpoint is circuit-broken
- Health monitoring shows per-endpoint circuit breaker states

### Implementation Requirements:

**Per-Endpoint Circuit Breaker Design**:
- Map<endpointUrl, BreakerState> for independent tracking
- Individual failure counters and success counters per endpoint
- Separate timeout tracking for each endpoint's recovery attempts
- State machine per endpoint: CLOSED/OPEN/HALF_OPEN
- Configurable thresholds per endpoint type (premium vs free)

**Integration Strategy**:
- Wrap each endpoint call with its specific circuit breaker
- Modify endpoint selection logic to skip OPEN breakers
- Update health monitoring to report per-endpoint breaker states
- Preserve existing endpoint rotation with healthy endpoints only
- Add circuit breaker state to endpoint health checks

### Testing Requirements:
- Test single endpoint failure doesn't affect other endpoint breakers
- Test cascade prevention during simultaneous endpoint issues
- Test endpoint recovery behavior (HALF_OPEN → CLOSED transitions)
- Verify endpoint rotation works around circuit-broken endpoints
- Test circuit breaker state reporting in health monitoring

### Expected Changes:

**Modified File**: `src/detection/transport/rpc-connection-pool.js`
- Replace single CircuitBreaker with PerEndpointCircuitBreaker class
- Modify call() method to check per-endpoint breaker state before calls
- Update endpoint selection to skip OPEN circuit breakers
- Add per-endpoint state tracking and recovery logic
- Update health monitoring to show individual breaker states

**New File**: `scripts/test-circuit-breakers.js`
- Test individual endpoint failures and circuit breaker behavior
- Test cascade prevention effectiveness (target: 90%+ prevention rate)
- Verify endpoint recovery happens independently
- Test endpoint rotation around circuit-broken endpoints
- Measure improvement in failure isolation

### Performance Requirements to Measure:

**Circuit Breaker Effectiveness Metrics**:
- Cascade prevention rate: Target 90%+ (up from current 50%)
- Endpoint failure isolation: 100% (one endpoint failure doesn't affect others)
- Recovery time per endpoint: 30-60 seconds after endpoint becomes healthy
- False positive rate: <5% (healthy endpoints shouldn't be circuit-broken)
- State transition accuracy: 100% correct CLOSED→OPEN→HALF_OPEN→CLOSED

**System Resilience Metrics**:
- System availability during single endpoint failure: 95%+ (should continue with other endpoints)
- Failover speed to healthy endpoints: <5 seconds when breaker opens
- Recovery detection speed: <2 attempts in HALF_OPEN state
- Error message clarity: Specific endpoint identified in failures
- Health monitoring accuracy: Real-time breaker state reporting

### If Circuit Breaker Tuning Fails:
1. Test PerEndpointCircuitBreaker class in isolation before integration
2. Verify state transitions work correctly for individual endpoints
3. Ensure endpoint selection properly skips OPEN breakers
4. Validate cascade prevention improvement with controlled endpoint failures

CRITICAL REQUIREMENTS:
- Cascade prevention rate must improve to 90%+ for production safety
- Individual endpoint failures must not affect other healthy endpoints
- Circuit breaker state must be visible per endpoint in monitoring
- Endpoint recovery must happen independently and automatically
- System must maintain high availability using healthy endpoints only

SUCCESS CRITERIA SUMMARY:
- Per-endpoint circuit breakers isolate failures effectively
- Cascade prevention rate improves from 50% to 90%+
- Endpoint rotation works around circuit-broken endpoints
- Individual endpoint recovery without affecting system availability
- Complete system reliability improvements ready for production deployment
```

## Your Post-Fix Process

After Claude Code completes circuit breaker tuning:

**Step 1: Test Per-Endpoint Circuit Breakers**
```bash
# Test circuit breaker isolation
node scripts/test-circuit-breakers.js

# Check cascade prevention improvement
grep -i "cascade.*prevention.*rate.*9[0-9]" circuit-breaker-test-results.txt

# Verify endpoint isolation working
grep -i "endpoint.*isolation.*100" circuit-breaker-test-results.txt
```

**Step 2: Validate Endpoint Recovery**
```bash
# Test individual endpoint recovery
node -e "
// Simulate endpoint failure and recovery
// Verify other endpoints continue working
// Check recovery happens independently
"

# Check circuit breaker states
grep -i "breaker.*state.*per.*endpoint" circuit-breaker-test-results.txt
```

**Step 3: Final System Validation**
```bash
# Record circuit breaker improvement
echo "Fix Session 4 Circuit Breakers: $(date)" >> development.log
echo "Cascade prevention: $(grep -o '[0-9]*%.*cascade.*prevention' circuit-breaker-test-results.txt)" >> development.log

# Commit circuit breaker tuning
git add src/detection/transport/rpc-connection-pool.js scripts/test-circuit-breakers.js
git commit -m "Fix Session 4: Per-endpoint circuit breakers - Improved cascade prevention and endpoint isolation"

# Tag complete fix implementation
git tag -a v1.1-reliability-fixes -m "All reliability fixes complete - Connection pool, memory cleanup, backpressure, circuit breakers"
```

**Step 4: Re-run Session 3C After All Fixes**
```bash
# Now re-test sustained load with all fixes applied
echo "All 4 fix sessions complete - ready to re-run Session 3C sustained load testing"
echo "Expected improvements:"
echo "- Success rate: 23% → 95%+ (connection pool + backpressure)"
echo "- Memory growth: 85%/hour → <2%/hour (resource cleanup)"  
echo "- Cascade prevention: 50% → 90%+ (per-endpoint circuit breakers)"
```

This completes all 4 focused fix sessions. Each addresses a specific aspect of the reliability issues identified in Session 3C stress testing, following Claude Code optimization principles for single focus and incremental implementation.