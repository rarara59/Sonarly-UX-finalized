PROMPT 2A: Token Bucket Component Testing
SINGLE FOCUS: Create comprehensive test suite for extracted token-bucket.js component
EXPLICIT FILE PATHS:

Target: tests/unit/token-bucket.test.js
Component Under Test: src/detection/transport/token-bucket.js

INCREMENTAL IMPLEMENTATION PROCESS:
Step 1: Create test framework and test environment setup for TokenBucket class in isolation
Step 2: Test rate limiting accuracy under normal load patterns with various request rates
Step 3: Test burst handling and token replenishment timing with spike load scenarios
Step 4: Test configuration loading and validation with valid/invalid environment variables
Step 5: Test memory usage and stability during sustained operation (5-minute continuous test)
CLEAR SUCCESS CRITERIA:
Rate Limiting Validation Requirements:

Process 1000 requests/sec with <10ms latency per token availability check
Rate limiting accuracy: 95%+ (properly rejects requests when tokens exhausted)
Burst tolerance: Allows 2x normal rate for up to 10 seconds as configured
Token replenishment: Accurate to within 1% of configured rate over measurement windows

Performance Requirements:

Token check latency: <1ms per hasTokens() call under normal and high load
Memory usage: <50MB for 100,000 token operations during sustained testing
Configuration loading: 100% success rate for valid environment variable combinations
Memory stability: No detectable memory leaks during 5-minute continuous operation

REQUIREMENTS-BASED VALIDATION:
Measure These Metrics:

Rate limiting accuracy percentage (target: 95%+ correct rejection when over limit)
Token check latency in milliseconds (target: <1ms per hasTokens() call)
Memory usage during sustained operation (target: <50MB throughout test)
Burst handling effectiveness (target: 2x rate tolerance for 10 seconds)
Configuration loading success rate (target: 100% for valid configurations)

Test Scenarios to Cover:

Normal steady-state operation: Consistent token consumption within limits
Burst scenarios: Sudden spike in token requests testing burst tolerance
Token exhaustion scenarios: Behavior when token bucket empty and requests rejected
Recovery scenarios: Token replenishment and availability after exhaustion periods
Configuration scenarios: Valid and invalid environment variable handling